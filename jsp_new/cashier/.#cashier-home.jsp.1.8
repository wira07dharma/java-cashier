
<%@page import="com.dimata.common.entity.system.PstSystemProperty"%>
<%@page import="com.dimata.posbo.entity.masterdata.Shift"%>
<%@page import="java.util.Date"%>
<%@page import="java.sql.Time"%>
<%@page import="com.dimata.util.Formater"%>
<%@page import="com.dimata.posbo.entity.masterdata.PstShift"%>
<%@page import="com.dimata.gui.jsp.ControlCombo"%>
<%@page import="com.dimata.common.entity.location.Location"%>
<%@page import="com.dimata.common.entity.location.PstLocation"%>
<%@page import="java.util.Vector"%>
<%@page import="com.dimata.util.Command"%>
<%@page import="com.dimata.pos.form.balance.FrmCashCashier"%>
<!DOCTYPE html>
<%@include file="../main/javainit_cashier.jsp" %>
<%  
    //ini adalah fungsi pengecekan apakah menggunakan approval finger atau tidak
    String verificationType = PstSystemProperty.getValueByName("KASIR_LOGIN_TYPE");
    String cssDisplay = "";
    if (verificationType.equals("1")){
        cssDisplay = "display:none;";
    }else{
        cssDisplay = "display:block;";
    } 
%>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Open Cashier - Dimata Cashier</title>
    <%@include  file="cashier-css.jsp"%>
    <!-- CSS FOR FINGER PRINT -->
    <style>
        .finger{
            width:20%; 
            height:auto;
            padding : 2%;
            float:left;
         }
        .finger_spot{
            width:90%;
            height: 80px;
            background-color :#e5e5e5;
            border : thin solid #c5c5c5;
            font-size: 0.8em;
            font-family:calibri;
            text-align:center;
            color :#FFF;
            border-radius: 3px;
        }


        .green{
           background-color : #5CB85C;
           border : thin solid #4CAE4C;
        }
    </style>
    <script type="text/javascript" src="../styles/cashier/dist/js/numberformat.js"></script>
  </head>
  <body class="skin-queentandoor sidebar-mini wysihtml5-supported sidebar-collapse fixed">
    <div class="wrapper">
      
      <header class="main-header">
	  <%@include file="cashier-header.jsp" %>
      </header>
      <!-- Left side column. contains the logo and sidebar -->
      <aside class="main-sidebar">
	    <%
		String home = "active";
		String transaction = "";
	    %>
	    <%@include file="cashier-sidebar.jsp" %>
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>
            Dimata Cashier
            <small>Open Cashier</small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-home"></i> Home</a></li>
            <li class="active">Open Cashier</li>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content">
	    <div class="row">
		<div class="col-md-12">
		    <div class="box box-primary">
			<div class="box-header with-border">
			    <h3 class="box-title">Open Cashier</h3>
			</div>
			<div class="box-body">
			    <div id="CONTENT_<%= FrmCashCashier.FRM_NAME_CASH_CASHIER %>" style="display:none;">
				<form  id="<%= FrmCashCashier.FRM_NAME_CASH_CASHIER %>">
				    <input type="hidden" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SPV_CLOSE_OID] %>" value="1">
				    <input type="hidden" name="command" id="command" value="<%= Command.SAVE %>">
				    <input type="hidden" name="loadtype" value="opencashier">
				    <div class="col-md-12">
					<div class="box-body">
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Cashier Name</div>
							    <div class="col-md-3">
								<input type="hidden" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_APP_USER_ID] %>" value="<%= userId %>">
								<%= userName %>
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Location</div>
							    <div class="col-md-3">
								<%
								    String defaultOidLocation = PstSystemProperty.getValueByName("OUTLET_DEFAULT_LOCATION");
								    String multiLocation = PstSystemProperty.getValueByName("OUTLET_MULTILOCATION");
								    
								    Vector location_key = new Vector(1,1);
								    Vector location_value = new Vector(1,1);
								    location_key.add("");
								    location_value.add("-- Select --");
								    
								    String whereClause = "";
								    if(multiLocation.equals("0")){
									whereClause = PstLocation.fieldNames[PstLocation.FLD_LOCATION_ID]+"='"+defaultOidLocation+"'";
								    }
								    
								    Vector listLocation = PstLocation.list(0, 0, 
									    ""+whereClause, "");

								    if(listLocation.size() != 0){
									for(int i=0; i<listLocation.size(); i++){
									    Location location = (Location) listLocation.get(i);

									    location_key.add(""+location.getOID());
									    location_value.add(""+location.getName());
									}
								    }
								%>
								<%=ControlCombo.drawBootsratap(FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_LOCATION],null,String.valueOf(0),location_key,location_value," required='required'","form-control enterPress")%>
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Shift</div>
							    <div class="col-md-3">
								<%
								    Vector shift_key = new Vector(1,1);
								    Vector shift_value = new Vector(1,1);

								    Vector listShift = PstShift.list(0, 0, "", PstShift.fieldNames[PstShift.FLD_END_TIME]+" DESC");

								    String newDateFormat = Formater.formatDate(new Date(), "HH:mm:ss");
								    Time getTime = Time.valueOf(newDateFormat);

								    if(listShift.size() != 0){
									for(int i=0; i<listShift.size(); i++){
									    Shift shift = (Shift) listShift.get(i);

									    String formatedStart = Formater.formatDate(shift.getStartTime(), "HH:mm:ss");
									    String formatedEnd = Formater.formatDate(shift.getEndTime(), "HH:mm:ss");
									    String displayStart = Formater.formatDate(shift.getStartTime(), "kk:mm:ss");
									    String displayEnd = Formater.formatDate(shift.getEndTime(), "kk:mm:ss");
									    if((getTime.after(Time.valueOf(formatedStart)) || getTime.equals(Time.valueOf(formatedStart))) && (getTime.before(Time.valueOf(formatedEnd)) || getTime.equals(Time.valueOf(formatedEnd)))){


										shift_key.add(""+shift.getOID());
										shift_value.add(""+shift.getRemark()+" ["+displayStart+" - "+displayEnd+"]");
									    }
									}
								    }

								%>
								<%=ControlCombo.drawBootsratap(FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SHIFT_ID],null,"",shift_key,shift_value," required='required'","form-control enterPress")%>
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Cashier Number</div>
							    <div class="col-md-3" id="LOAD_<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_CASH_MASTER_ID] %>">
								Please select location
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Opening Rp</div>
							    <div class="col-md-3">
								<input type="text" id ="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SUBTOTAL1] %>" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SUBTOTAL1] %>" class="form-control money enterPress" required="required">
								<input type="hidden" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_CURRENCY_ID] %>" value="1">
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Opening USD</div>
							    <div class="col-md-3">
								<input type="text" id="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SUBTOTAL2] %>" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SUBTOTAL2] %>" class="form-control money enterPress" required="required">
								<input type="hidden" name="<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_CURRENCY_ID2] %>" value="2">
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row">&nbsp;</div>
                                            <div class="row" style="<%=cssDisplay%>">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Supervisor ID</div>
							    <div class="col-md-3">
								<input type="text" id="SUPERVISOR_USERNAME" name="SUPERVISOR_USERNAME" class="form-control enterPress" required="required">
							    </div>
							</div>
						    </div>
						</div>
					    </div>
					    <div class="row" style="<%=cssDisplay%>">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <div class="col-md-3 col-md-offset-3">Supervisor Password</div>
							    <div class="col-md-3">
                                                                <input type="password" id="SUPERVISOR_PASSWORD" name="SUPERVISOR_PASSWORD" class="form-control enterPress" required="required">
							    </div>
							</div>
						    </div>
						</div>
					    </div>
                                            
                                            
					    <div class="row">&nbsp;</div>
                                            <div class="row" style="<%=cssDisplay%>">
						<div class="col-md-12">
						    <div class="box-body">
							<div class="col-md-12">
							    <center><input type="submit" value="Open Cashier" class="btn btn-primary" id="btnOpen"></center>
							</div>
						    </div>
						</div>
					    </div>
					</div>
				    </div>
				</form>
                                <%
                                            if (verificationType.equals("1")){
                                            %>
                                            <div class="row">
                                                 <div class="box-body">
                                                     <div class="col-md-12">
                                                        <div class="col-md-12">
                                                            <div class="col-md-3 col-md-offset-3">Supervisor ID</div>
                                                            <div class="col-md-3">
                                                                <input type="text" id="spvFinger" required="required" class="form-control" placeholder="Supervisor Username" name="">
                                                            </div>
                                                        </div>
                                                    </div>
                                                 </div>
                                            </div>
                                            <div class="row">
                                                 <div class="box-body">
                                                     <div class="col-md-12">
                                                        <div class="col-md-12">
                                                            <div class="col-md-3 col-md-offset-3">&nbsp;</div>
                                                            <div class="col-md-3">
                                                                <div id="dynamicPlace"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                 </div>
                                            </div>
                                            <%}%>
			    </div>
			    <div id="CONTENT_LOAD_TEXT">
				<h3 class="box-title">
				    Checking open cashier
				</h3>
			    </div>
			</div>
			<div class="overlay" id="CONTENT_ANIMATE_CHECK">
			    <i class="fa fa-refresh fa-spin"></i>
			</div>
		    </div>
		</div>
	    </div>
        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->
      <footer class="main-footer">
        <div class="pull-right hidden-xs">
          <b>Version</b> 1.0
        </div>
	  <strong>Copyright &copy; 2015 <a href="http://almsaeedstudio.com">Dimata IT Solution &REG;</a>.</strong> All rights reserved.
      </footer>
      
      
    </div><!-- ./wrapper -->
    
    <!--JQUERY & BOOTSTRAP COMPONEN -->
    <%@include file="cashier-jquery-bootstrap.jsp" %>
    
     <script type="text/javascript">
	 $(document).ready(function (){
	 
	    function  OpenCashier(datasend, loadplace, usedataload){
		$("#CONTENT_ANIMATE_CHECK").fadeIn("medium");
		$("#CONTENT_LOAD_TEXT").show();
		
		if(usedataload == true){
		    $.ajax({
			type    : "POST",
			url	    : "<%= approot %>/OpenCashierHandler",
			data    : datasend,
			cache   : false,
			success : function(data){
			    $("#CONTENT_ANIMATE_CHECK").hide();
			    $("#CONTENT_LOAD_TEXT").hide();
			    $("#"+loadplace).html(data).fadeIn("medium");
			    
			},
			error : function(){
			    //alert("error");
			}
                    }).done(function(data){
                        enterPress();
		    });
		}else{
		    $.ajax({
			type    : "POST",
			url	    : "<%= approot %>/OpenCashierHandler",
			data    : datasend,
			cache   : false,
			success : function(data){
			    $("#CONTENT_ANIMATE_CHECK").hide();
			    $("#CONTENT_LOAD_TEXT").hide();

			    if(data > 0){
				$("#resultMessage").html("<b>CASHIER ALREADY OPENED</b><br>Redirecting to Transaction Page").show();
				$("#result").addClass("modal-info");
				$("#result").modal("show");
				window.location = "<%= approot %>/cashier/cashier-transaction.jsp";
			    }else{
				$("#"+loadplace).fadeIn("medium");
			    }
			},
			error : function(){
			    //alert("error");
			}
                    }).done(function(data){
                        enterPress();
		    });
		}
	    }
	    
	    //LOAD DATA
	    var loaddata = {
		"loadtype":"checkopencashier", 
		"<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_SPV_OID] %>":"<%= userId %>",
		"command":"<%= Command.NONE %>"
	    };
	    OpenCashier(loaddata, "CONTENT_<%= FrmCashCashier.FRM_NAME_CASH_CASHIER %>", false);
	    
	    $("#<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_LOCATION] %>").change(function(){
		
		var loaddata = {
		    "loadtype":"checkcashiernumb",
		    "command":"<%= Command.NONE %>",
		    "<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_LOCATION] %>":$(this).val()
		};
		
		OpenCashier(loaddata,"LOAD_<%= FrmCashCashier.fieldNames[FrmCashCashier.FRM_FIELD_CASH_MASTER_ID] %>", true);
	    });
	    
	    //OPEN CASHIER
	    $("form#<%= FrmCashCashier.FRM_NAME_CASH_CASHIER %>").submit(function(){
               
		$("#btnOpen").attr({"value":"Please wait..","disabled":true});
		$.ajax({
		    type    : "POST",
		    url	    : "<%= approot %>/OpenCashierHandler",
		    data    : $(this).serialize(),
		    cache   : false,
		    success : function(data){
			$("#btnOpen").removeAttr("disabled").attr({"value":"Open Cashier"});
			$("#CONTENT_ANIMATE_CHECK").hide();
			$("#CONTENT_LOAD_TEXT").hide();
			
			if(data > 0){
			    $("#resultMessage").html("<b>OPEN CASHIER FAILED</b><br>Invalid supervisor username or password").show();
			    $(".modal").addClass("modal-danger");
			    $("#result").modal("show");
			}else{
			    $("#resultMessage").html("<b>OPEN CASHIER SUCCESS</b><br>Redirecting to Transaction Page").show();
			    $(".modal").addClass("modal-success");
			    $("#result").modal("show");
			    window.location = "<%= approot %>/cashier/cashier-transaction.jsp";
			}
			
			
		    },
		    error : function(){
			//alert("error");
		    }
		});
		return false;
	    });
	    
	    //MODAL OPTION
	    $("#result").modal({
		"backdrop" : "static",
		"keyboard" : false,
		"show" : false
	    });
            
            //
            var base = "<%=baseURL%>";
            var interval =0;
            
            function keyPressProcessing(controlId){
                var listControl = [
                    "FRM_FIELD_LOCATION", 
                    "FRM_FIELD_SHIFT_ID", 
                    "FRM_FIELD_CASH_MASTER_ID",
                    "FRM_FIELD_SUBTOTAL1",
                    "FRM_FIELD_SUBTOTAL2",
                    "SUPERVISOR_USERNAME",
                    "SUPERVISOR_PASSWORD"
                ];
                
                var listDestination = [
                    "FRM_FIELD_SHIFT_ID",
                    "FRM_FIELD_CASH_MASTER_ID",
                    "FRM_FIELD_SUBTOTAL1",
                    "FRM_FIELD_SUBTOTAL2",
                    "SUPERVISOR_USERNAME",
                    "SUPERVISOR_PASSWORD",
                    "SUBMIT"
                ];
                
                var index = listControl.indexOf(controlId); 
                var destination = listDestination[index];
                
                return destination;
            }
            
            function ajaxFingerHandler(url,data,type,appendTo,another,optional,optional2){
                $.ajax({
                    url : ""+url+"",
                    data: ""+data+"",
                    type : ""+type+"",
                    async : false,
                    cache: false,
                    success : function(data) {
                        if (another=="checkUser"){
                            $(''+appendTo+'').html(data);
                        }

                    },
                    error : function(data){
                        //alert('error');
                    }
                }).done(function(data){

                    if (another=="checkUser"){
                        fingerClick();  
                        getCode();    
                    }else if (another=="getCode"){
                        $('#SUPERVISOR_PASSWORD').val(data);
                    }else if (another=="checkStatusUser"){

                        if (data==1){
                            clearInterval(interval);
                            var userName = $('#spvFinger').val();
                            $('#SUPERVISOR_USERNAME').val(userName);
                            alert('Verification success...');
                            $('#<%= FrmCashCashier.FRM_NAME_CASH_CASHIER %>').submit();
                        }
                    }
                });
            }

            function checkUser(){
                var url = ""+base+"/FingerHandler";
                var loginId = $('#spvFinger').val();
                var data="command=<%=Command.ASK%>&login="+loginId+"&base="+base+"&group=0&type=1";
                ajaxFingerHandler(url,data,"POST","#dynamicPlace","checkUser","","");
            }

            function checkStatusUser(userId){
                var url = ""+base+"/FingerHandler";
                var data="command=<%=Command.SEARCH%>&loginId="+userId+"&group=0&type=1";
                ajaxFingerHandler(url,data,"POST","","checkStatusUser","","");
            }

            function getCode(){
                var url = ""+base+"/FingerHandler";
                var loginId = $('#spvFinger').val();
                var data="command=<%=Command.DETAIL%>&login="+loginId+"";
                ajaxFingerHandler(url,data,"POST","","getCode","","");
            }

            function fingerClick(){
                $('.loginFinger').click(function(){
                    var loginId= $('#spvFinger').val();
                    interval =  setInterval(function() {
                        checkStatusUser(loginId);
                    },5000);

                });
            }

            $('#spvFinger').keyup(function(){
                checkUser();
            });
            
            //$(".money").maskMoney({allowZero:true,decimal:'.'});
            $('.money').keyup(function(){
                var value = $(this).val();
                var conValue = parserNumber(value,false,0,'');
                $(this).val(conValue);
            });
            
            setTimeout(function(){
                $('#FRM_FIELD_LOCATION').focus();
            }, 200);
            
            function enterPress(){
                $('.enterPress').keydown(function(e){ 
                    if (e.keyCode == 13) {
                        var id =$(this).attr('id');
                        var dest = keyPressProcessing(id);
                        if (dest!="SUBMIT"){
                            $('#'+dest+'').focus();
                            e.preventDefault();
                            return false; 
                        }

                    }
                });
            }
            enterPress();
            checkUser();
	 });
     </script>
     <!-- BAGIAN INI ADALAH SCRIPT UNTUK FINGER -->
    
    <div id="result" class="modal">
      <div class="modal-dialog">
	<div class="modal-content">
	  <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	    <h4 class="modal-title">INFO</h4>
	  </div>
	  <div class="modal-body" id="resultMessage">
	  </div>
	  <div class="modal-footer">
	    <button type="button" class="btn btn-outline" data-dismiss="modal">Close</button>
	  </div>
	</div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    
    <!-- PLUGINS COMPONEN -->
    <%@include file="cashier-plugin.jsp" %>
  </body>
</html>